<!----
****************************************************************************************************
* 프로그램 개요
****************************************************************************************************
1. 모듈 : [CTA] 통합계약서 작성 Step4
2. 프로그램 ID : WwctaContractRegistrationMgtMStep4
3. 작성자 : gs.piit159
4. 작성일 : 2023.05.31
****************************************************************************************************
* 프로그램 설명
****************************************************************************************************
- 통합계약서 작성 Step4
****************************************************************************************************
--->
<template>
  <kw-scroll-area
    visible
  >
    <div class="pr20">
      <h3 class="mt0">
        계약자정보-{{ getCodeName('CNTR_TP_CD', step4.bas?.cntrTpCd) }}
      </h3>
      <kw-form
        v-if="step4.cntrt?.copnDvCd === COPN_DV_CD.INDIVIDUAL"
        :cols="2"
        dense
        class="mt20"
      >
        <kw-form-row>
          <kw-form-item
            :label="$t('MSG_TXT_CNTRT')"
          >
            <p>
              {{
                `${step4.cntrt.cstKnm || ''} / ${
                  stringUtil.getDateFormat(step4.cntrt.bryyMmdd)} / ${
                  getCodeName('SEX_DV_CD', step4.cntrt.sexDvCd) || ''}`
              }}
            </p>
          </kw-form-item>
          <kw-form-item
            :label="$t('MSG_TXT_CST_NO')"
          >
            <p>
              {{ step4.cntrt.cstNo }}
            </p>
          </kw-form-item>
        </kw-form-row>
        <kw-form-row>
          <kw-form-item
            :label="$t('MSG_TXT_MPNO')"
          >
            <p>
              {{ step4.cntrt.cralLocaraTno }}-{{
                step4.cntrt.mexnoEncr
              }}-{{ step4.cntrt.cralIdvTno }}
            </p>
          </kw-form-item>
          <kw-form-item
            :label="$t('MSG_TXT_ADDR')"
          >
            <p>
              {{ step4.cntrt.zip }}<br>
              {{ step4.cntrt.adr }} {{ step4.cntrt.adrDtl }}
            </p>
          </kw-form-item>
        </kw-form-row>
      </kw-form>
      <kw-form
        v-else-if="step4.cntrt?.copnDvCd === COPN_DV_CD.COOPERATION"
      >
        <kw-form-row>
          <kw-form-item
            :label="$t('MSG_TXT_CNTRT')"
          >
            <p>{{ step4.cntrt.cstKnm }}</p>
          </kw-form-item>
          <kw-form-item
            :label="$t('MSG_TXT_CRNO')"
          >
            <p>{{ step4.cntrt.bzrno }}</p>
          </kw-form-item>
        </kw-form-row>
        <kw-form-row>
          <kw-form-item
            :label="$t('MSG_TXT_CST_NO')"
          >
            <p>{{ step4.cntrt.cstNo }}</p>
          </kw-form-item>
        </kw-form-row>
        <kw-form-row>
          <kw-form-item
            :label="$t('MSG_TXT_MPNO')"
          >
            <p>
              {{ step4.cntrt.cralLocaraTno }}-{{
                step4.cntrt.mexnoEncr
              }}-{{ step4.cntrt.cralIdvTno }}
            </p>
          </kw-form-item>
          <kw-form-item
            :label="$t('MSG_TXT_TEL_NO')"
          >
            <p>
              {{ step4.cntrt.locaraTno }}-{{ step4.cntrt.exnoEncr }}-{{ step4.cntrt.idvTno }}
            </p>
          </kw-form-item>
        </kw-form-row>
        <kw-form-row>
          <kw-form-item
            :label="$t('MSG_TXT_ADDR')"
          >
            <p>
              {{ step4.cntrt.zip }}<br>
              {{ step4.cntrt.adr }} {{ step4.cntrt.adrDtl }}
            </p>
          </kw-form-item>
        </kw-form-row>
      </kw-form>

      <kw-separator />

      <template v-if="step4.value?.bas?.cstStlmInMthCd !== '30'">
        <h3>고객결제방법 선택</h3>

        <kw-form
          :cols="1"
          class="mt20"
        >
          <kw-form-row>
            <kw-form-item label="고객결제방법선택">
              <p
                v-if="isReadonly"
              >
                {{
                  codes.CST_STLM_IN_MTH_CD.find((code) => code.codeId === step4.bas?.cstStlmInMthCd)?.codeName
                }}
              </p>
              <kw-option-group
                v-else
                :model-value="step4.bas?.cstStlmInMthCd"
                type="radio"
                :options="codes.CST_STLM_IN_MTH_CD"
              />
            </kw-form-item><!--TODO CHECK-->
          </kw-form-row>
        </kw-form>
      </template>

      <kw-separator />

      <h3>계약목록</h3>

      <kw-action-top class="mt20">
        <template #left>
          <kw-paging-info :total-count="countGrdMain" />
        </template>
        <span class="kw-fc--black3">
          (단위: 원/월)
        </span>
      </kw-action-top>

      <kw-grid
        ref="grdMainRef"
        name="grdMain"
        :visible-rows="countGrdMain"
        @init="initGrdMain"
      />

      <kw-action-top class="mt20">
        <template #left>
          <kw-paging-info :total-count="countGrdStlm" />
        </template>
        <span class="kw-fc--black3">
          (단위: 원)
        </span>
      </kw-action-top>

      <kw-grid
        ref="grdStlmRef"
        name="grdStlm"
        :visible-rows="countGrdStlm"
        @init="initGrdStlm"
      />

      <kw-separator />

      <h3>{{ $t('MSG_TXT_PRTNR_INF') }}</h3>

      <kw-form
        :cols="2"
        dense
        class="mt20"
      >
        <kw-form-row>
          <kw-form-item label="파트너명">
            <p>{{ step4.prtnr?.prtnrKnm }}</p>
          </kw-form-item>
          <kw-form-item label="사번">
            <p>{{ step4.prtnr?.prtnrNo }}</p>
          </kw-form-item>
        </kw-form-row>
        <kw-form-row>
          <kw-form-item label="지점명">
            <p>{{ step4.prtnr?.dgr3LevlOgNm }}</p>
          </kw-form-item>
          <kw-form-item label="지점장명">
            <p>{{ step4.prtnr?.dgr3LevlDgPrtnrNm }}</p>
          </kw-form-item>
        </kw-form-row>
      </kw-form>

      <kw-separator class="my20" />

      <template
        v-for="(item, idx) in step4.dtls"
        :key="idx"
      >
        <template
          v-if="item.cntrSn === dtlSn"
        >
          <!-- rev:230426  1번의페이징에 따라 화면변경됨-->
          <div class="row justify-between">
            <div class="row items-center">
              <h3 class="my0">
                {{ item.pdClsfNm }}
                <kw-separator
                  spaced
                  vertical
                  class="mx12 my5"
                />
                {{ item.pdNm }}
              </h3>
            </div>
            <div class="row items-center">
              <p
                class="kw-fc--primary kw-font-subtitle"
              >
                {{ getDisplayedFinalPrice(item) }}
              </p>

              <div class="row items-center ml20">
                <kw-btn
                  icon="arrow_left_24"
                  borderless
                  class="kw-font-pt24"
                  @click="onClickPrevDtlSn"
                />
                <p class="kw-font-pt18 kw-fc--black1 mx4">
                  <span>{{ dtlSn }}</span>
                  <span class="kw-fc--placeholder">/{{ step4.dtls.length }}</span>
                </p>
                <kw-btn
                  icon="arrow_right_24"
                  borderless
                  class="kw-font-pt24"
                  @click="onClickNextDtlSn"
                />
              </div>
            </div>
          </div>

          <kw-separator class="mt20" />

          <template
            v-if="item.sodbtNftfCntrYn !== 'Y'"
          >
            <h3>결제정보</h3>

            <kw-form
              v-if="step4.bas?.cstStlmInMthCd !== '30'"
              :cols="2"
              class="mt20"
              dense
            >
              <kw-form-row
                v-if="step4.bas?.copnDvCd === '2'"
              >
                <kw-form-item
                  :label="t('MSG_TXT_TXINV_PBL')"
                >
                  <p>
                    {{ getCodeName('COD_YN', item.txinvPblOjYn) }}
                  </p>
                </kw-form-item>
              </kw-form-row>
              <template
                v-if="item.sellTpCd === '1'"
              >
                <kw-form-row>
                  <kw-form-item label="계약금(카드)">
                    <p>
                      {{ stringUtil.getNumberWithComma(item.cntrAmtCrd || 0) }}
                    </p>
                  </kw-form-item>
                  <kw-form-item label="계약금(가상계좌)">
                    <p>
                      {{ stringUtil.getNumberWithComma(item.cntrAmtVac || 0) }}
                    </p>
                  </kw-form-item>
                </kw-form-row>
                <kw-form-row
                  v-if="item.recapMshPtrm > 0"
                >
                  <kw-form-item label="멤버십계좌이체">
                    <p>
                      {{
                        codes.DP_TP_CD_AFTN.find((code) => code.codeId === item.dpTpCdMsh)?.codeName
                      }}
                    </p>
                  </kw-form-item>
                </kw-form-row>
                <kw-form-row
                  v-if="item.recapMshPtrm > 0"
                >
                  <kw-form-item
                    no-label
                    :colspan="2"
                  >
                    <h3 class="my0">
                      멤버십 금액 : {{ stringUtil.getNumberWithComma(item.mshAmt || 0) }}원
                    </h3>
                  </kw-form-item>
                </kw-form-row>
              </template>
              <template
                v-else
              >
                <kw-form-row>
                  <kw-form-item
                    label="자동이체"
                  >
                    <p>
                      {{
                        codes.DP_TP_CD_AFTN.find((code) => code.codeId === item.dpTpCdAftn)?.codeName
                      }}
                    </p>
                  </kw-form-item>
                  <kw-form-item no-label>
                    <p class="kw-fc--black2 kw-font-pt14 text-weight-regular">
                      월 납부금 : {{ stringUtil.getNumberWithComma(item.fnlAmt || 0) }}원
                    </p>
                  </kw-form-item>
                </kw-form-row>
                <kw-form-row>
                  <kw-form-item label="등록비결제유형">
                    <p>
                      {{
                        codes.DP_TP_CD_IDRV.find((code) => code.codeId === item.dpTpCdIdrv)?.codeName
                      }}
                    </p>
                  </kw-form-item>
                  <kw-form-item no-label>
                    <p class="kw-fc--black2 kw-font-pt14 text-weight-regular">
                      등록비 : {{ stringUtil.getNumberWithComma(item.cntrAmt || 0) }}원
                    </p>
                  </kw-form-item>
                </kw-form-row>
              </template>
            </kw-form>

            <kw-separator />
          </template>

          <h3>설치 및 배송 주소</h3>

          <kw-form
            v-if="item.adrpc"
            :cols="2"
            dense
            class="mt20"
          >
            <kw-form-row>
              <kw-form-item
                label="받는사람"
              >
                <p>{{ item.adrpc.rcgvpKnm }}</p>
              </kw-form-item>
            </kw-form-row>
            <kw-form-row>
              <kw-form-item
                label="휴대전화번호"
              >
                <p>
                  {{ item.adrpc.cralLocaraTno }}-{{ item.adrpc.mexnoEncr }}-{{
                    item.adrpc.cralIdvTno
                  }}
                </p>
              </kw-form-item>
              <kw-form-item
                label="전화번호"
              >
                <p>
                  {{ item.adrpc.locaraTno }}-{{ item.adrpc.exnoEncr }}-{{ item.adrpc.idvTno }}
                </p>
              </kw-form-item>
            </kw-form-row>
            <kw-form-row>
              <kw-form-item
                label="주소"
                :colspan="2"
              >
                <p>
                  {{ item.adrpc.zip }}<br>
                  {{ item.adrpc.adr }} {{ item.adrpc.adrDtl }}
                </p>
              </kw-form-item>
            </kw-form-row>
          </kw-form>

          <kw-separator />

          <h3>설치환경 및 요청사항</h3>

          <kw-form
            :cols="2"
            dense
            class="mt20"
          >
            <template
              v-if="item.sellTpCd === '1' || item.sellTpCd === '2'"
            >
              <kw-form-row>
                <kw-form-item
                  label="설치장소"
                >
                  <p>
                    {{
                      codes.IST_PLC_TP_CD.find((code) => code.codeId === item.wellsDtl.istPlcTpCd)?.codeName
                    }}
                  </p>
                </kw-form-item>
                <kw-form-item
                  label="가구 구성원 수"
                >
                  <p>
                    {{ codes.FMMB_N.find((code) => code.codeId === item.wellsDtl.fmmbN)?.codeName }}
                  </p>
                </kw-form-item>
              </kw-form-row>
              <kw-form-row>
                <kw-form-item
                  label="전압"
                >
                  <p>
                    {{
                      codes.USE_ELECT_TP_CD.find((code) => code.codeId === item.wellsDtl.useElectTpCd)?.codeName
                    }}
                  </p>
                </kw-form-item>
                <kw-form-item
                  label="수압"
                >
                  <p>
                    {{
                      codes.WPRS_ITST_TP_CD.find((code) => code.codeId === item.wellsDtl.wprsItstTpCd)?.codeName
                    }}
                  </p>
                </kw-form-item>
              </kw-form-row>
              <kw-form-row>
                <kw-form-item
                  label="수질"
                >
                  <p>
                    {{
                      codes.SRCWT_TP_CD.find((code) => code.codeId === item.wellsDtl.srcwtTpCd)?.codeName
                    }}
                  </p>
                </kw-form-item>
              </kw-form-row>
              <kw-form-row>
                <kw-form-item
                  label="요청사항"
                  :colspan="2"
                >
                  <p>
                    {{ item.wellsDtl.istAkArtcMoCn }}
                  </p>
                </kw-form-item>
              </kw-form-row>
              <kw-form-row>
                <kw-form-item
                  label="참고사항"
                  :colspan="2"
                >
                  <p>
                    {{ '' }}
                  </p>
                </kw-form-item>
              </kw-form-row>
            </template>
            <template
              v-else
            >
              <kw-form-row>
                <kw-form-item
                  label="요청사항"
                  :colspan="2"
                >
                  <p>
                    {{ item.wellsDtl.istAkArtcMoCn }}
                  </p>
                </kw-form-item>
              </kw-form-row>
            </template>
          </kw-form>
        </template>
      </template>

      <template v-if="isRestipulation">
        <h3>재약정</h3>

        <kw-form
          :cols="2"
          class="mt20"
        >
          <kw-form-row>
            <kw-form-item
              label="약정유형"
            >
              <kw-select
                v-model="restipulationBasInfo.stplTpCd"
                :options="stplTpCdOptions"
                option-value="rstlBaseTpCd"
                option-label="text"
                @change="calcRestipulation"
              />
            </kw-form-item>
            <kw-form-item
              label="재약정개월"
            >
              <p>{{ `${restipulationBasInfo.stplPtrm || 0}개월` }}</p>
            </kw-form-item>
          </kw-form-row>
          <kw-form-row>
            <kw-form-item
              label="약정시작"
            >
              <p>{{ stringUtil.getDateFormat(restipulationBasInfo.stplStrtdt) }}</p>
            </kw-form-item>
            <kw-form-item
              label="약정종료"
            >
              <p>{{ stringUtil.getDateFormat(restipulationBasInfo.stplEnddt) }}</p>
            </kw-form-item>
          </kw-form-row>
          <kw-form-row>
            <kw-form-item
              label="약정요금"
            >
              <p>
                {{ `${getNumberWithComma(restipulationBasInfo.newFnlValue)}원` }}
              </p>
            </kw-form-item>
            <kw-form-item
              label="재약정할인"
            >
              <p>
                {{ `${getNumberWithComma(restipulationBasInfo.stplDscAmt)}원` }}
              </p>
            </kw-form-item>
          </kw-form-row>
        </kw-form>
      </template>

      <template v-if="isCorpDscAdrChg">
        <kw-separator />
        <h3>법인할인고객 주소변경</h3>

        <kw-form
          :cols="1"
          class="mt20"
        >
          <kw-form-row>
            <kw-form-item
              label="첨부파일"
              required
            >
              <zwcm-file-attacher
                ref="attachFileRef"
                v-model="fileParams.dcevdnDocs"
                attach-group-id="ATG_CTA_CNTR_FILE"
                :attach-document-id="fileParams.dcevdnDocId"
                class="mb20"
                :name="$t('MSG_TXT_ATTH_FILE')"
                downloadable
                required
              />
            </kw-form-item>
          </kw-form-row>
        </kw-form>
      </template>
    </div>
  </kw-scroll-area>
  <kw-separator
    spaced
    vertical
    inset
    class="ma0"
  />
</template>

<script setup>
// -------------------------------------------------------------------------------------------------
// Import & Declaration
// -------------------------------------------------------------------------------------------------
import ZwcmFileAttacher from '~common/components/ZwcmFileAttacher.vue';
import {
  defineGrid,
  getComponentType,
  gridUtil,
  stringUtil,
  useDataService,
  useGlobal,
} from 'kw-lib';
import { cloneDeep, isEmpty } from 'lodash-es';
import dayjs from 'dayjs';
import { warn } from 'vue';
import { getNumberWithComma } from '~sms-common/contract/util';
import { useCtCode } from '~sms-common/contract/composable';
import { CNTR_TP_CD, COPN_DV_CD } from '~sms-wells/contract/constants/ctConst';

const props = defineProps({
  contract: { type: Object, required: true },
});
const emit = defineEmits([
  'activated',
]);
const exposed = {};
defineExpose(exposed);

const dataService = useDataService();
const { notify, alert } = useGlobal();
const { getters } = useStore();
const { codes, getCodeName } = await useCtCode(
  'CNTR_TP_CD',
  'SEX_DV_CD',
  'CST_STLM_IN_MTH_CD',
  'IST_PLC_TP_CD',
  'WRFR_IST_MTH_CD',
  'SRCWT_TP_CD',
  'WPRS_ITST_TP_CD',
  'USE_ELECT_TP_CD',
  'COD_YN',
  'SELL_TP_CD',
  'SV_IST_PCSV_DV_CD',
);
codes.FMMB_N = [
  { codeId: 1, codeName: '1인 가구' },
  { codeId: 2, codeName: '2인 가구' },
  { codeId: 3, codeName: '3인 가구' },
  { codeId: 4, codeName: '4인 이상 가구' },
];
codes.DP_TP_CD_IDRV = [
  { codeId: '0201', codeName: '카드' },
  { codeId: '0101', codeName: '가상계좌' },
];
codes.DP_TP_CD_AFTN = [
  { codeId: '0203', codeName: '카드이체' },
  { codeId: '0102', codeName: '계좌이체' },
  { codeId: '0104', codeName: '법인계좌' },
];

const sessionUserId = getters['meta/getUserInfo'];
const step4 = toRef(props.contract, 'step4', {
  bas: {},
  cntrt: {},
  prtnr: {},
  cntrDtls: [{}],
  stlmDtls: [{}],
});
const ogStep4 = ref({});
const isRestipulation = ref(false);
const restipulationBasInfo = toRef(props.contract, 'restipulationBasInfo', {});
const isCorpDscAdrChg = ref(false);
const stplTpCdOptions = ref([]);

const { t } = useI18n();
const grdMainRef = ref(getComponentType('KwGrid'));
const grdStlmRef = ref(getComponentType('KwGrid'));
const countGrdMain = ref(1);
const countGrdStlm = ref(1);

const dtlSn = ref(1);
const now = dayjs();
const isReadonly = computed(() => step4.value.bas?.cntrPrgsStatCd > 20);
const fileParams = ref({
  dcevdnDocs: [],
  dcevdnDocId: '', // 법인할인고객 주소변경
});
// -------------------------------------------------------------------------------------------------
// Function & Event
// -------------------------------------------------------------------------------------------------
function setGrid() {
  const viewMain = grdMainRef.value.getView();
  const viewStlm = grdStlmRef.value.getView();
  viewMain.getDataSource()
    .setRows(step4.value.cntrDtls);
  viewStlm.getDataSource()
    .setRows(step4.value.stlmDtls);
  countGrdMain.value = Math.max(step4.value.cntrDtls.length, 1);
  countGrdStlm.value = Math.max(step4.value.stlmDtls.length, 1);
}

async function calcRestipulation() {
  const stplTpCdOption = stplTpCdOptions.value
    .find((option) => option.rstlBaseTpCd === restipulationBasInfo.value.stplTpCd);
  const ojCntrDtl = step4.value.dtls.find((dtl) => Number(dtl.cntrSn) === Number(restipulationBasInfo.value.cntrSn));

  restipulationBasInfo.value.stplDscAmt = stplTpCdOption.stplDscAmt;
  restipulationBasInfo.value.stplPtrm = stplTpCdOption.rstlMcn;
  restipulationBasInfo.value.minRentalAmt = stplTpCdOption.minRentalAmt;

  if (!ojCntrDtl) {
    warn('재약정 대상 계약 상세가 없습니다.');
    return;
  }
  restipulationBasInfo.value.newFnlValue = Number(ojCntrDtl.fnlAmt) - Number(restipulationBasInfo.value.stplDscAmt);
  // 최소금액 이하로 떨어지는 경우 로직 보완
  if (Number(restipulationBasInfo.value.newFnlValue) < Number(restipulationBasInfo.value.minRentalAmt)) {
    restipulationBasInfo.value.newFnlValue = restipulationBasInfo.value.minRentalAmt;
    restipulationBasInfo.value.stplDscAmt = Number(restipulationBasInfo.value.newFnlValue)
      - Number(restipulationBasInfo.value.minRentalAmt);
  }

  if (!restipulationBasInfo.value.newFnlValue) {
    return;
  }
  const { data } = await dataService.get(
    'sms/wells/contract/re-stipulation/contract-info',
    { params: restipulationBasInfo.value },
  );

  const stplExpired = Number(data.rentalTn) >= Number(data.stplPtrm);
  const startDayOfNextMonth = now
    .add(1, 'month')
    .startOf('M');
  const startDayOfStplEndMonth = dayjs(data.istDt, 'YYYYMMDD')
    .add(Number(data.stplPtrm), 'month')
    .startOf('M');

  const stplStrtDay = stplExpired ? startDayOfNextMonth : startDayOfStplEndMonth;
  const stplEndDay = stplStrtDay
    .add(Number(restipulationBasInfo.value.stplPtrm) - 1, 'month')
    .endOf('M');
  const stplStrtdt = stplStrtDay.format('YYYYMMDD')
    .toString();
  const stplEnddt = stplEndDay.format('YYYYMMDD')
    .toString();
  restipulationBasInfo.value.cntrNo = data.cntrNo;
  restipulationBasInfo.value.stplStrtdt = stplStrtdt;
  restipulationBasInfo.value.stplEnddt = stplEnddt;
  restipulationBasInfo.value.rstlStatCd = '010'; // 접수
  restipulationBasInfo.value.stplRcpDtm = now.format('YYYYMMDDHHmmss')
    .toString();
  restipulationBasInfo.value.rcpOgTpCd = sessionUserId.ogTpCd;
  restipulationBasInfo.value.rcpPrtnrNo = sessionUserId.employeeIDNumber;
  restipulationBasInfo.value.stplTn = Number(data.stplTn) + 1;
}

async function getCntrInfo() {
  const { cntrNo, rstlCntrNo } = props.contract;
  if (!rstlCntrNo && !cntrNo) {
    await alert('잘못된 접근입니다.');
    return;
  }
  const { data } = await dataService.get('sms/wells/contract/contracts/cntr-info', {
    params: {
      cntrNo: rstlCntrNo || cntrNo,
      step: 4,
      rstlYn: rstlCntrNo ? 'Y' : 'N',
    },
  });

  step4.value = data.step4;
  ogStep4.value = cloneDeep(step4.value);
  // 총판채널인 경우 고객센터 이관만 보이도록
  codes.CST_STLM_IN_MTH_CD = codes.CST_STLM_IN_MTH_CD.filter((code) => (step4.value.bas.cstStlmInMthCd === '30' ? code.codeId === '30' : code.codeId !== '30'));

  // 법인할인고객 주소변경 관련 첨부파일ID
  fileParams.value.dcevdnDocId = step4.value.bas.dcevdnDocId;
  setGrid();
}

async function fetchStplTpCdOptions() {
  const { rstlCntrNo: cntrNo, rstlCntrSn: cntrSn } = props.contract;
  const { data } = await dataService.get(
    'sms/wells/contract/re-stipulation/standard-info',
    { params: { cntrNo, cntrSn } },
  );
  stplTpCdOptions.value = data;
}

async function fetchInitialStplTpCd() {
  const { rstlCntrNo: cntrNo, rstlCntrSn: cntrSn } = props.contract;
  const response = await dataService.get(
    'sms/wells/contract/re-stipulation/contract',
    { params: { cntrNo, cntrSn } },
  );
  restipulationBasInfo.value.cntrNo = cntrNo;
  restipulationBasInfo.value.cntrSn = cntrSn;
  restipulationBasInfo.value.stplTpCd = response.data.stplTpCd;
}

async function getCntrInfoWithRstl() {
  const { rstlCntrNo, rstlCntrSn } = props.contract;
  if (!rstlCntrNo || !rstlCntrSn) {
    await alert('잘못된 접근입니다.');
    return;
  }

  restipulationBasInfo.value = {};

  await getCntrInfo();

  step4.value.bas.cntrTpCd = CNTR_TP_CD.RE_STIPULATION; // notify 계약서 유형을 재약정은 덮어씁니다.!

  await fetchStplTpCdOptions();
  await fetchInitialStplTpCd();

  isRestipulation.value = true;
}

function isChangedStep() {
  return true;
}

async function isValidStep() {
  // 법인할인고객 주소변경 첨부파일 확인
  if (isCorpDscAdrChg.value) {
    // console.log(JSON.stringify(fileParams.value, null, '\t'));
    if (isEmpty(fileParams.value.dcevdnDocs)) {
      await alert('법인할인고객주소변경의 경우 첨부파일은 필수입니다.');
      return false;
    }
  }

  if (isRestipulation.value) {
    if (!restipulationBasInfo.value.stplTpCd) {
      await alert('재약정유형을 선택해주세요.');
      return false;
    }
  }
  return true;
}

async function validateCustomer(cntrt) {
  const { cikVal, hsCtfYn, itgCstNo, copnDvCd } = cntrt;

  if (copnDvCd === COPN_DV_CD.INDIVIDUAL) {
    if (!cikVal) {
      // await alert('본인인증 미완료 상태입니다.\n완료 후 계약자를 재 조회해 주세요.'); /* 네이버렌탈 */
      // return false; // TODO: re-rollback 다시살리기, 20231228 rollback: 전아영 매니저님 요청에 의한 일시 제거
    }
    if (hsCtfYn !== 'Y') {
      // await alert('고객 정보 변경으로 본인인증이 필요합니다.\n완료 후 계약자를 재 조회해 주세요.');
      // return false; // 20231228 rollback: 전아영 매니저님 요청에 의한 일시 제거
    }
    if (!itgCstNo) {
      // await alert('통합고객 약관동의 미완료 상태입니다.\n완료 후 계약자를 재 조회해 주세요.');
      // return false; // 20231228 rollback: 전아영 매니저님 요청에 의한 일시 제거
    }
  }

  return true;
}

async function saveStep(isTemp) {
  if (isRestipulation.value) {
    const savedCntr = await dataService.post('sms/wells/contract/re-stipulation/save-contract', restipulationBasInfo.value);
    return savedCntr?.data?.key;
  }

  if (!await validateCustomer()) {
    return false;
  }

  // 법인할인고객 주소변경 첨부파일이 존재하는 경우,
  if (!isEmpty(fileParams.value.dcevdnDocs)) {
    step4.value.bas.dcevdnDocs = fileParams.value.dcevdnDocs;
    // step4.value.bas.dcevdnDocId = fileParams.value.dcevdnDocId;
  }

  const api = isTemp ? 'save-cntr-step4-temp' : 'save-cntr-step4';
  const savedCntr = await dataService.post(`sms/wells/contract/contracts/${api}`, step4.value);
  notify(t('MSG_ALT_SAVE_DATA'));
  ogStep4.value = cloneDeep(step4.value);
  return savedCntr?.data?.key;
}

function onClickPrevDtlSn() {
  if (dtlSn.value > 1) dtlSn.value -= 1;
}

function onClickNextDtlSn() {
  if (dtlSn.value < step4.value.dtls.length) dtlSn.value += 1;
}

function getDisplayedFinalPrice(cntrDtl) {
  if (!cntrDtl) {
    return '';
  }
  const { fnlAmt, svPrd, sellTpCd, stplPtrm } = cntrDtl;

  if (sellTpCd === '1') {
    return `${getNumberWithComma(fnlAmt)}원`;
  }
  if (sellTpCd === '2') {
    return `${getNumberWithComma(fnlAmt)}원${stplPtrm ? ` (${stplPtrm}개월)` : ''}`;
  }
  if (sellTpCd === '6') {
    return `${getNumberWithComma(fnlAmt)}원 (월 ${getNumberWithComma(fnlAmt
      / svPrd)}원)`;
  }
  return `월 ${getNumberWithComma(fnlAmt)}원`;
}

const loaded = ref(false);

async function initStep(forced = false) {
  if (!forced && loaded.value) {
    return;
  }

  const { cntrNo, rstlCntrNo } = props.contract;
  if (rstlCntrNo) {
    await getCntrInfoWithRstl();
  } else if (cntrNo) {
    await getCntrInfo();
  }

  loaded.value = true;

  // 법인할인고객 주소변경 확인
  if (step4.value?.bas.copnDvCd === COPN_DV_CD.COOPERATION) {
    const { data } = await dataService.get('sms/wells/contract/contracts/is-change-corp-address', {
      params: {
        cntrNo,
      },
    });
    isCorpDscAdrChg.value = data;
    // console.log(JSON.stringify(data, null, '\t'));
  }
}

exposed.getCntrInfo = getCntrInfo;
exposed.getCntrInfoWithRstl = getCntrInfoWithRstl;
exposed.isChangedStep = isChangedStep;
exposed.isValidStep = isValidStep;
exposed.initStep = initStep;
exposed.loaded = loaded;
exposed.saveStep = saveStep;

onActivated(() => {
  initStep();
  emit('activated', 4);
});
// -------------------------------------------------------------------------------------------------
// Initialize Grid
// -------------------------------------------------------------------------------------------------
const initGrdMain = defineGrid((data, view) => {
  const fields = [
    { fieldName: 'cntrNo' },
    { fieldName: 'cntrSn' },
    { fieldName: 'sellTpCd' },
    { fieldName: 'sellTpNm' },
    { fieldName: 'pdNm' },
    { fieldName: 'cstBasePdAbbrNm' },
    { fieldName: 'regAmt', dataType: 'number' },
    { fieldName: 'rntlAmt', dataType: 'number' },
    { fieldName: 'pdAmt', dataType: 'number' },
    { fieldName: 'stplPtrm', dataType: 'number' },
    { fieldName: 'cntrPtrm', dataType: 'number' },
    { fieldName: 'dscAmt', dataType: 'number' },
    { fieldName: 'svIstPcsvDvCd' },
    { fieldName: 'svPrd' },
  ];
  const columns = [
    {
      fieldName: 'cntrNo',
      header: t('MSG_TXT_CNTR_DTL_NO'),
      width: '140',
      styleName: 'text-center',
      displayCallback(grid, index) {
        const { cntrNo: pCntrNo, cntrSn } = grid.getValues(index.itemIndex);
        return `${pCntrNo}-${cntrSn}`;
      },
    },
    { fieldName: 'sellTpCd', header: t('MSG_TXT_CNTR_DV'), fillWidth: 1, options: codes.SELL_TP_CD },
    { fieldName: 'pdNm',
      header: t('MSG_TXT_PRDT_NM'),
      width: 200,
      displayCallback: (g, i) => {
        const { pdNm, cstBasePdAbbrNm } = gridUtil.getRowValue(g, i.dataRow);
        return cstBasePdAbbrNm || pdNm;
      },
    },
    { fieldName: 'regAmt', header: '등록비(계약금)', fillWidth: 1, styleName: 'text-right' },
    { fieldName: 'rntlAmt', header: '월납부금', fillWidth: 1, styleName: 'text-right' },
    { fieldName: 'pdAmt', header: t('MSG_TXT_PRDT_AMT'), fillWidth: 1, styleName: 'text-right' },
    {
      fieldName: 'stplPtrm',
      header: t('MSG_TXT_CONTRACT_PERI'),
      width: 90,
      styleName: 'text-right',
    },
    { fieldName: 'cntrPtrm', header: t('MSG_TXT_CNTR_PTRM'), width: 90, styleName: 'text-right' },
    { fieldName: 'dscAmt', header: t('MSG_TXT_DSC_AMT'), fillWidth: 1, styleName: 'text-right' },
    { fieldName: 'svIstPcsvDvCd', header: '설치/택배', fillWidth: 1, options: codes.SV_IST_PCSV_DV_CD },
    { fieldName: 'svPrd',
      header: '서비스주기',
      width: 90,
      styleName: 'text-right',
      displayCallback: (g, i) => {
        const { svPrd } = gridUtil.getRowValue(g, i.dataRow);
        return svPrd ? `${svPrd}개월` : '';
      },
    },
  ];
  data.setFields(fields);
  view.setColumns(columns);
  view.rowIndicator.visible = true;
});

const initGrdStlm = defineGrid((data, view) => {
  const fields = [
    { fieldName: 'stlmTp' },
    { fieldName: 'stlmMth' },
    { fieldName: 'stlmAmt', dataType: 'number' },
  ];
  const columns = [
    { fieldName: 'stlmTp', header: t('MSG_TXT_PMT_TYP'), width: 200 },
    { fieldName: 'stlmMth', header: t('MSG_TXT_STLM_MTHD'), width: 200 },
    { fieldName: 'stlmAmt', header: t('MSG_TXT_AMT'), fillWidth: 1, styleName: 'text-right' },
  ];
  data.setFields(fields);
  view.setColumns(columns);
  view.rowIndicator.visible = true;
});
</script>

<style scoped lang="scss">
</style>
