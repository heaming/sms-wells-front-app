<template>
  <div class="scoped-product-select">
    <div class="scoped-product-select__search-box scoped-search-box">
      <h3
        class="scoped-search-box__title"
      >
        상품검색
        <kw-icon
          name="info"
          class="ml4 hp-h-auto"
          tooltip-self="top left"
        >
          <p>
            모종 정기배송 상품의 경우,<br>
            웰스팜 기기 제품 선택하고<br>
            패키지 상품으로 추가하시거나,<br>
            기존에 구매하신 웰스팜 기기를 선택하신 후,<br>
            선택하실 수 있습니다.
          </p>
        </kw-icon>
      </h3>
      <kw-input
        v-model="searchParams.filterText"
        placeholder="상품명"
        @keydown.enter="onClickSearch"
      />
      <kw-select
        v-if="searchExpaneded"
        v-model="searchParams.sellTpCd"
        class="mt8"
        :options="codes.SELL_TP_CD"
        first-option="select"
        first-option-label="판매유형 선택"
        @change="onClickSearch"
      />
      <kw-select
        v-if="machineryCntrDtlOptions?.length && searchExpaneded"
        v-model="machineryCntrDtlCntrNoSn"
        class="mt8"
        :options="machineryCntrDtlOptions"
        first-option="select"
        first-option-label="모종기기 선택"
        @change="onChangeWellsFarmMachineCntrDtl"
      />
      <div class="scoped-search-box__action">
        <kw-btn
          underline
          secondary
          :label="searchExpaneded ? '숨기기' : '더보기'"
          dense
          :icon-right="'arrow_down'"
          size="12px"
          class="scoped-expand-btn"
          :class="{'scoped-expand-btn--expanded': searchExpaneded}"
          @click="onClickExpansionToggleBtn"
        />
        <kw-btn
          secondary
          label="초기화"
          dense
          class="w60"
          @click="onClickReset"
        />
        <kw-btn
          label="조회"
          class="w60"
          dense
          filled
          color="secondary"
          text-color="bg-white"
          @click="onClickSearch"
        />
      </div>
    </div>
    <div
      v-scrollbar
      class="scoped-product-select__product-box"
    >
      <div class="pr30 pb20">
        <kw-list
          class="scoped-product-type-list"
          separator
        >
          <kw-expansion-item
            v-for="(pdClsfCd) in filteredPdClsfCds"
            :key="`product-type-${pdClsfCd}`"
            :ref="(vm) => expansionItemRef[pdClsfCd] = vm"
            padding-target="header"
            expansion-icon-align="center"
            expand-icon-class="hidden"
            expand-icon-toggle
          >
            <template #header="{ toggle, expanded }">
              <kw-item-section>
                <kw-btn
                  class="kw-font-body fit scoped-expand-btn py16"
                  :class="{'scoped-expand-btn--expanded': expanded}"
                  borderless
                  :label="getCodeName('PD_CLSF_CD', pdClsfCd)"
                  icon-right="arrow_down"
                  @click="toggle"
                />
              </kw-item-section>
            </template>
            <template #default>
              <kw-virtual-scroll
                v-slot="{item: product, index: idx}"
                scroll-target=".scoped-product-select__product-box"
                virtual-scroll-item-size="79"
                virtual-scroll-slice-ratio-after="3"
                class="scoped-product-picker-list"
                :items="filteredClassifyingProducts[pdClsfCd]"
                type="list"
                debounce="50"
              >
                <kw-item
                  :key="`product-${idx}`"
                  class="scoped-product-picker-list__item"
                  padding="16px 0"
                >
                  <kw-item-section>
                    <kw-item-label
                      font="dense"
                      font-weight="400"
                      class="flex no-wrap"
                    >
                      <div
                        class="ellipsis grow pr20 cursor-pointer"
                        @click="onClickProduct(product)"
                      >
                        {{ product.cstBasePdAbbrNm || product.pdNm }}
                        <kw-tooltip show-when-ellipsised>
                          {{ product.cstBasePdAbbrNm || product.pdNm }}
                        </kw-tooltip>
                      </div>
                    </kw-item-label>
                    <kw-item-label
                      class="mt6 flex gap-xxs"
                    >
                      <kw-chip
                        v-if="labelForSellTpCd(product)"
                        :label="labelForSellTpCd(product)"
                        color="primary"
                        outline
                      />
                    </kw-item-label>
                  </kw-item-section>
                </kw-item>
              </kw-virtual-scroll>
            </template>
          </kw-expansion-item>
        </kw-list>
      </div>
    </div>
  </div>
</template>

<script setup>
// -------------------------------------------------------------------------------------------------
// Import & Declaration
// -------------------------------------------------------------------------------------------------
import { alert, useDataService, stringUtil } from 'kw-lib';
import { useCtCode } from '~sms-common/contract/composable';
import { vScrollbar } from '~sms-common/contract/util';
import { PD_TP_CD, SELL_TP_CD } from '~sms-wells/contract/constants/ctConst';

const props = defineProps({
  cntrNo: { type: String, required: true },
});
const emit = defineEmits([
  'select',
  'fetched',
]);
const exposed = {};

defineExpose(exposed);

const { t } = useI18n();
const dataService = useDataService();
const { codes, addCode, getCodeName } = await useCtCode(
  'SELL_TP_DTL_CD',
  'PD_TP_CD',
  'RGLR_SPP_MCHN_TP_CD',
);
await addCode('SELL_TP_CD', (code) => ([
  SELL_TP_CD.SPAY,
  SELL_TP_CD.RENTAL,
  SELL_TP_CD.MSH,
  SELL_TP_CD.RGLR_SPP,
].includes(code.codeId) && code));
await addCode('PD_CLSF_CD', [
  { codeId: 'CLSF_CD_1', codeName: '정수기' },
  { codeId: 'CLSF_CD_2', codeName: '청정기' },
  { codeId: 'CLSF_CD_3', codeName: '비데' },
  { codeId: 'CLSF_CD_4', codeName: '삼성가전' },
  { codeId: 'CLSF_CD_5', codeName: '정기배송' },
  { codeId: 'CLSF_CD_6', codeName: '기타' },
  { codeId: 'CLSF_CD_7', codeName: '복합상품' },
]);

const cntrNo = ref(props.cntrNo);

const expansionItemRef = ref({});
const searchExpaneded = ref(true);
const products = ref([]);
const classifyingProducts = ref({});
const selectedProductCode = ref();
const machineryCntrDtlOptions = ref();
const machineryCntrDtlCntrNoSn = ref();
const wellsFarmMchnCntrDtl = computed(() => {
  const machineryCntrDtlOption = (machineryCntrDtlOptions.value ?? [])
    .find((option) => option.codeId === machineryCntrDtlCntrNoSn.value);
  return machineryCntrDtlOption?.cntrDtl;
});

const cachedParams = ref({});
const searchParams = ref({
  filterText: '',
  sellTpCd: undefined,
  rglrSppMchnTpCd: undefined,
});

function getPdClsfCd(product) {
  if (!product) {
    return;
  }
  if (product.pdTpCd === PD_TP_CD.COMPOSITION) {
    return 'CLSF_CD_7';
  }
  if (product.istBzsCd === 'S') {
    return 'CLSF_CD_4';
  }
  if (product.sellTpCd === SELL_TP_CD.RGLR_SPP) {
    return 'CLSF_CD_5';
  }
  if (product.pdMclsfId === 'PDC000000000002') {
    return 'CLSF_CD_1';
  }
  if (product.pdMclsfId === 'PDC000000000026') {
    return 'CLSF_CD_2';
  }
  if (product.pdMclsfId === 'PDC000000000056') {
    return 'CLSF_CD_3';
  }
  return 'CLSF_CD_6';
}

function labelForSellTpCd(product) {
  if (!product) {
    return undefined;
  }
  if (product.sellTpCd && product.sellTpDtlCd) {
    return `${getCodeName('SELL_TP_CD', product.sellTpCd)}-${getCodeName('SELL_TP_DTL_CD', product.sellTpDtlCd)}`;
  }
  if (product.sellTpCd) {
    return getCodeName('SELL_TP_CD', product.sellTpCd);
  }
  if (product.pdTpCd === 'C') {
    return getCodeName('PD_TP_CD', product.pdTpCd);
  }
}

function classifying() {
  if (!products.value?.length) {
    classifyingProducts.value = {};
  }

  const mappingObj = {
    CLSF_CD_1: undefined,
    CLSF_CD_2: undefined,
    CLSF_CD_3: undefined,
    CLSF_CD_4: undefined,
    CLSF_CD_5: undefined,
    CLSF_CD_6: undefined,
    CLSF_CD_7: undefined,
  };

  const addPdToMapping = (product) => {
    const pdClsfCd = getPdClsfCd(product);
    product.pdClsfNm = getCodeName('PD_CLSF_CD', pdClsfCd);
    if (pdClsfCd) {
      mappingObj[pdClsfCd] ??= [];
      mappingObj[pdClsfCd].push(product);
    }
  };
  products.value
    .forEach(addPdToMapping);
  Object.getOwnPropertyNames(mappingObj)
    .forEach((pdClsfCd) => {
      if (!mappingObj[pdClsfCd]) {
        delete mappingObj[pdClsfCd];
      }
    });

  classifyingProducts.value = mappingObj;
}

const filteredClassifyingProducts = computed(() => {
  if (!cachedParams.value) {
    return classifyingProducts.value;
  }
  const pdClsfCds = Object.keys(classifyingProducts.value);
  return pdClsfCds.reduce((filtered, pdClsfCd) => {
    const classified = classifyingProducts.value[pdClsfCd];
    if (!classified?.length) {
      return filtered;
    }
    const filterText = cachedParams.value.filterText?.toUpperCase() || '';
    const { sellTpCd, rglrSppMchnTpCd } = cachedParams.value;
    const filteredProducts = classified
      .filter((product) => (!filterText
            || product.pdCd?.includes(filterText)
            || product.pdNm?.toUpperCase()
              .includes(filterText)
            || product.cstBasePdAbbrNm?.toUpperCase()
              .includes(filterText)
      ))
      .filter((product) => (!sellTpCd || product.sellTpCd === sellTpCd))
      .filter((product) => (rglrSppMchnTpCd ? product.rglrSppMchnTpCd === rglrSppMchnTpCd : (product.rglrSppMchnTpCd ?? '0') === '0'));

    if (filteredProducts.length) {
      filtered[pdClsfCd] = Object.freeze(filteredProducts);
    }
    return filtered;
  }, {});
});

const filteredPdClsfCds = computed(() => Object.keys(filteredClassifyingProducts.value));

async function fetchProducts() {
  cntrNo.value = props.cntrNo;

  if (!cntrNo.value) {
    return;
  }

  const { data } = await dataService.get('sms/wells/contract/contracts/products', {
    params: {
      cntrNo: cntrNo.value,
    },
  });
  products.value = data;
  if (!data?.length) {
    await alert('판매 가능한 상품이 없습니다.');
  }
  classifying();

  // 멤버십 계약 등 1개 상품만 있는 경우, 자동 선택 처리
  // 세부적인 판단은 Step2.vue 에서
  // emit 성능이 문제된다면, length=1 인 경우에만 전달 등 추후 정리
  await emit('fetched', products.value);
}

async function fetchMachines() {
  const params = {
    cntrNo: props.cntrNo,
  };
  const { data } = await dataService.get('/sms/wells/contract/seeding/machinery', { params });
  if (data?.length) {
    machineryCntrDtlOptions.value = data.map((cntrDtl) => ({
      codeId: `${cntrDtl.cntrNo}-${cntrDtl.cntrSn}`,
      codeName: `${cntrDtl.pdNm
      } / ${cntrDtl.cntrNo}-${cntrDtl.cntrSn
      } / ${t('설치일')}:${stringUtil.getDateFormat(cntrDtl.istDt)
      } / ${getCodeName('RGLR_SPP_MCHN_TP_CD', cntrDtl.rglrSppMchnTpCd)}`,
      cntrDtl,
    }));
  }
}

watch(() => props.cntrNo, () => {
  fetchProducts();
  fetchMachines();
});

async function onClickSearch() {
  const shouldFetchProduct = false;

  cachedParams.value = searchParams.value;
  if (shouldFetchProduct) {
    await fetchProducts();
  } else {
    await nextTick();
  }
  const filteredClassifiedGroup = filteredPdClsfCds.value;
  if (filteredClassifiedGroup.length) {
    expansionItemRef.value[filteredClassifiedGroup[0]]?.show();
  }
}

function onClickReset() {
  searchParams.value.filterText = '';
  searchParams.value.sellTpCd = undefined;
  searchParams.value.rglrSppMchnTpCd = undefined;
  selectedProductCode.value = undefined;
  onClickSearch();
}

function onChangeWellsFarmMachineCntrDtl() {
  if (wellsFarmMchnCntrDtl.value) {
    searchParams.value.rglrSppMchnTpCd = wellsFarmMchnCntrDtl.value?.rglrSppMchnTpCd;
    searchParams.value.sellTpCd = SELL_TP_CD.RGLR_SPP;
  } else {
    searchParams.value.rglrSppMchnTpCd = undefined;
  }
  onClickSearch();
}

async function onClickProduct(product) {
  await emit('select', product, wellsFarmMchnCntrDtl.value);
}

function onClickExpansionToggleBtn() {
  searchExpaneded.value = !searchExpaneded.value;
}

onMounted(() => {
  // step2 로 바로 접근하는 경우...
  if (!products.value?.length) {
    fetchProducts();
    fetchMachines();
  }
});

onActivated(() => {
  if (!products.value?.length) {
    fetchProducts();
  }
});
</script>

<style lang="scss" scoped>
@import "~@css/variables";

.scoped-product-select {
  display: flex;
  flex-flow: column nowrap;

  &__search-box {
    flex: none;
  }

  &__product-box {
    flex: 1 1 1px;
  }
}

.scoped-search-box {
  padding-bottom: $spacing-lg;
  border-bottom: 1px solid $line-line;
  margin-right: 30px;

  &__title {
    margin-top: 0;
  }

  &__action {
    margin-top: $spacing-sm;
    display: flex;
    flex-flow: row nowrap;
    justify-content: flex-end;
    gap: $spacing-xs;
  }
}

.scoped-product-picker-list {
  background-color: $bg-box;
  padding: 0 $spacing-lg;

  :deep(> .kw-item-type:not(:first-of-type)) {
    // margin-top: $spacing-lg;
  }
}

.scoped-expand-btn {
  margin-right: auto;
  font-size: 14px;

  &.kw-btn {
    :deep(.q-icon) {
      transition: transform $button-transition;
    }
  }

  &--expanded {
    &.kw-btn {
      :deep(.q-icon) {
        transform: rotate(180deg);
      }
    }
  }
}
</style>
