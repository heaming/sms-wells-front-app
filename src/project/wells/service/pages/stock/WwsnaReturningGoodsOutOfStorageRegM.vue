<!----
 ****************************************************************************************************
 * 프로그램 개요
 ****************************************************************************************************
 1. 모듈 : SNA (재고관리)
 2. 프로그램 ID : WwsnaReturningGoodsOutOfStorageRegM - 반품출고 등록(W-SV-U-0001M01)
 3. 작성자 : hyewon.kim ,
             SongTaeSung
 4. 작성일 : 2023.02.13
 ****************************************************************************************************
 * 프로그램 설명
 ****************************************************************************************************
 - 반품출고 등록 (http://localhost:3000/#/service/wwsna-returning-goods-out-of-storage-reg)
 ****************************************************************************************************
--->
<template>
  <kw-page>
    <kw-search
      class="kw-search-style"
      :cols="2"
      default-visible-rows="3"
      no-reset-btn
    >
      <kw-search-row>
        <!-- 출고유형 -->
        <kw-search-item
          :label="$t('MSG_TXT_OSTR_TP')"
          required
        >
          <!-- :readonly="hasProps()" -->
          <kw-select
            v-model="searchParams.ostrTpCd"
            :label="$t('MSG_TXT_OSTR_TP')"
            :options="ostrTpCds"
            rules="required"
            :readonly="true"
            @change="onChangeOstrTp"
          />
        </kw-search-item>
        <!-- 출고창고 -->
        <kw-search-item
          :label="$t('MSG_TXT_OSTR_WARE')"
          required
        >
          <kw-select
            v-model="searchParams.ostrWareNo"
            :label="$t('MSG_TXT_OSTR_WARE')"
            :options="warehouses"
            rules="required"
            :readonly="hasProps()"
            @change="onChangeOstrWareNo"
          />
        </kw-search-item>
      </kw-search-row>
      <kw-search-row>
        <!-- 출고일자 -->
        <kw-search-item
          :label="$t('MSG_TXT_OSTR_DT')"
          required
        >
          <kw-date-picker
            v-model="searchParams.ostrDt"
            :label="$t('MSG_TXT_OSTR_DT')"
            rules="required"
            :readonly="hasProps()"
          />
        </kw-search-item>
        <!-- 입고창고 -->
        <kw-search-item :label="$t('MSG_TXT_STR_WARE')">
          <kw-input
            v-model="searchParams.strWareNm"
            :disable="searchParams.ostrTpCd !== RETURN_INSIDE"
            readonly
          />
        </kw-search-item>
      </kw-search-row>
      <kw-search-row>
        <!-- 운송코드 -->
        <kw-search-item
          :label="$t('MSG_TXT_TRNSPN_CD')"
          required
        >
          <kw-select
            v-model="searchParams.trnspnCd"
            :label="$t('MSG_TXT_TRNSPN_CD')"
            rules="required"
            :options="trnspnCds"
            :readonly="hasProps()"
          />
        </kw-search-item>
      </kw-search-row>
    </kw-search>
    <div class="result-area">
      <kw-action-top>
        <template #left>
          <kw-paging-info
            :total-count="pageInfo.totalCount"
          />
          <span class="ml8">{{ t('MSG_TXT_UNIT_EA') }}</span>
        </template>
        <!-- 삭제 -->
        <kw-btn
          v-permission:delete
          dense
          secondary
          :label="$t('MSG_BTN_DEL')"
          @click="onClickDelete"
        />
        <kw-separator
          spaced
          vertical
          inset
        />
        <!-- 품목 추가 -->
        <kw-btn
          v-permission:create
          dense
          secondary
          :label="$t('MSG_BTN_ITM_SPMT')"
          :disable="canEdit()"
          @click="onClickAddItems"
        />
        <kw-separator
          spaced
          vertical
          inset
        />
        <!-- 상품등급 -->
        <kw-select
          v-model="baseInfo.pdGdCd"
          dense
          class="w150"
          :options="pdGdCds"
          :disable="canEdit()"
        />
        <!-- 등급 일괄변경 -->
        <kw-btn
          v-permission:read
          dense
          secondary
          :label="$t('MSG_BTN_GD_BLK_CH')"
          :disable="canEdit()"
          @click="onClickGridBulkChange(baseInfo.pdGdCd, 'itmGdCd')"
        />
        <kw-separator
          spaced
          vertical
          inset
        />
        <!-- 사유 -->
        <kw-select
          v-model="baseInfo.ostrRsonCd"
          dense
          class="w150"
          :options="ostrRsonCds"
          :disable="canEdit()"
        />
        <!-- 사유 일괄변경 -->
        <kw-btn
          v-permission:read
          dense
          secondary
          :label="$t('MSG_BTN_RSON_BLK_CH')"
          :disable="canEdit()"
          @click="onClickGridBulkChange(baseInfo.ostrRsonCd, 'ostrRsonCd')"
        />
        <kw-separator
          spaced
          vertical
          inset
        />
        <!-- 반품출고 등록 -->
        <kw-btn
          v-permission:update
          primary
          dense
          :label="$t('MSG_BTN_RTNGD_OSTR_RGST')"
          :disable="canEdit()"
          @click="onClickSave"
        />
      </kw-action-top>
      <kw-grid
        ref="grdMainRef"
        name="grdMain"
        :page-size="pageInfo.pageSize"
        :total-count="pageInfo.totalCount"
        @init="initGrdMain"
      />
    </div>
  </kw-page>
</template>

<script setup>
// -------------------------------------------------------------------------------------------------
// Import & Declaration
// -------------------------------------------------------------------------------------------------
import { codeUtil, defineGrid, getComponentType, gridUtil, useDataService, useGlobal, useMeta } from 'kw-lib';
import useSnCode from '~sms-wells/service/composables/useSnCode';
import dayjs from 'dayjs';
import { isEmpty } from 'lodash-es';

const { t } = useI18n();
const { getters } = useStore();
const dataService = useDataService();

const { getConfig } = useMeta();
const { modal, notify, alert } = useGlobal();

const { getWarehouseCloseCheck } = useSnCode();
const { employeeIDNumber } = getters['meta/getUserInfo'];

// TODO: 출고관리(W-SV-U-0141M01) 그리드 내부 버튼으로 호출된 경우 사용
const props = defineProps({
  ostrTpCd: {
    type: String,
    required: true,
    default: '',
  },
  ostrWareNo: {
    type: String,
    required: true,
    default: '',
  },
  ostrDt: {
    type: String,
    required: true,
    default: '',
  },
  strWareNo: {
    type: String,
    default: '',
  },
  strWareDvCd: { // 입고창고구분코드가 '1' (물류센터) 일 경우 수정 가능
    type: String,
    default: '',
  },
  itmOstrNo: {
    type: String,
    default: '',
  },
});

const DISUSE = '212'; // 폐기출고
const RETURN_INSIDE = '261'; // 반품출고(내부)
const RETURN_OUTSIDE = '262'; // 반품출고(외부)

// -------------------------------------------------------------------------------------------------
// Function & Event
// -------------------------------------------------------------------------------------------------
const grdMainRef = ref(getComponentType('KwGrid'));

const codes = await codeUtil.getMultiCodes(
  'COD_PAGE_SIZE_OPTIONS',
  'OSTR_TP_CD', // 출고구분코드
  'WARE_DV_CD', // 창고구분코드
  'MNGT_UNIT_CD', // 관리단위코드
  'PD_GD_CD', // 상품등급코드
  'RTNGD_RSON_CD', // 반품사유 (출고사유코드)
  'DSU_RSON_CD', // 폐기사유 (출고사유코드)
  'SPP_MTHD_TP_CD', // 배송방식유형코드
);

const pdGdCds = codes.PD_GD_CD.filter((v) => ['A', 'B', 'E', 'R', 'X'].includes(v.codeId));

const trnspnCds = codes.SPP_MTHD_TP_CD.filter((v) => ['6', '5', '0'].includes(v.codeId));

// 출고유형코드 필터링
function isReturingCode(codeId) {
  return codeId === RETURN_INSIDE;
}
const ostrTpCds = codes.OSTR_TP_CD.filter((v) => isReturingCode(v.codeId));

const baseInfo = ref({
  pdGdCd: '',
  ostrRsonCd: '',
});

const searchParams = ref({
  ostrTpCd: ostrTpCds[0].codeId, // 출고유형
  ostrWareNo: '', // 출고창고
  ostrDt: dayjs().format('YYYYMMDD'), // 출고일자
  strWareNo: '', // 입고창고
  strWareNm: '', // 입고창고명
  itmOstrNo: '', // 품목출고번호
  strWareDvCd: '', // 입고창고구분코드
  trnspnCd: '', // 운송코드
});

const pageInfo = ref({
  totalCount: 0,
  pageSize: Number(getConfig('CFG_CMZ_DEFAULT_PAGE_SIZE')),
});

const warehouses = ref([]);
const ostrRsonCds = ref(codes.DSU_RSON_CD);

// 전체건수 셋팅
function setTotalCount() {
  pageInfo.value.totalCount = grdMainRef.value.getView().getItemCount();
}

// 출고수량 체크
function validateOstrQty(row, val) {
  const grid = grdMainRef.value.getView();
  const onQty = gridUtil.getCellValue(grid, row, 'onQty');

  if (onQty < val) {
    notify(t('MSG_ALT_OSTR_QTY_EXCEEDS_INVEN_QTY'));
    return false;
  }
  return true;
}

// 입력 값 체크
function validateInputValueExists(input, inputType) {
  if (input === '') {
    notify(t('MSG_ALT_SELECT_VAL', [inputType]));
    return false;
  }
  return true;
}

// 인덱스가 null 인지 체크
function isIndexEmpty(obj) {
  return (obj === undefined || obj === null || obj === '');
}

// 적용건수 체크
function validateIsApplyRowExists() {
  const view = grdMainRef.value.getView();
  if (view.getItemCount() === 0) {
    notify(t('MSG_ALT_NO_APPY_OBJ_DT'));
    return false;
  }
  return true;
}

let viewCurrentLength = 0;

// 시점재고 조회
async function fetchPitmStoc(rows, itmGdCd, index) {
  const view = grdMainRef.value.getView();
  const itmPdCds = rows.map((v) => v.itmPdCd);
  const res = await dataService.post(`/sms/wells/service/returning-goods-out-of-storages/${searchParams.value.ostrWareNo}`, { itmPdCds, itmGdCd });
  let startRow = 0;

  if (isIndexEmpty(index)) {
    startRow = viewCurrentLength;
  }
  for (let i = 0; i < rows.length; i += 1) {
    if (res.data[i].itmPdCd === rows[i].itmPdCd) {
      if (isIndexEmpty(index)) {
        view.setValue(startRow + i, 'onQty', res.data[i].pitmQty);
      } else {
        view.setValue(index, 'onQty', res.data[i].pitmQty);
      }
    }
  }
}

// 그리드 "사유" 전체 변경
function onClickGridBulkChange(val, type) {
  const inputType = type === 'itmGdCd' ? '등급' : '사유';

  if (!validateInputValueExists(val, inputType)) return;
  if (!validateIsApplyRowExists()) return;

  const view = grdMainRef.value.getView();
  const rowCount = view.getItemCount();

  for (let dataRow = 0; dataRow < rowCount; dataRow += 1) {
    view.setValue(dataRow, type, val);
  }
  // {0} 항목이 일괄변경 되었습니다.
  notify(t('MSG_ALT_BULK_APPLY_SUCCESS', [inputType]));
}

// 그리드 row 데이터 가져오기
function getRowData(rowData) {
  return { ...rowData,
    sapMatCd: rowData.sapCd,
    onQty: 0,
    mngtUnitCd: rowData.delUntNm,
    itmKndCd: rowData.itmKnd,
    itmPdNm: rowData.itmPdAbbr1 };
}

// 품목기본정보 팝업 오픈
async function openItemBasePopup(type, row) {
  if (isEmpty(searchParams.value.ostrWareNo)) {
    // 해당사용자는 수불관리 창고가 존재하지 않습니다.
    await alert(t('MSG_ALT_USR_RVPY_WARE_NEX'));
    return;
  }

  const { result, payload } = await modal({
    component: 'WwsnaItemBaseInformationListP',
    componentProps: { chk: '1', lpGbYn: type === 'U' ? 'Y' : '', wareNo: searchParams.value.ostrWareNo },
  });

  const target = [];
  if (result) {
    const view = grdMainRef.value.getView();
    const list = gridUtil.getAllRowValues(view, false);
    if (type === 'C') {
      payload.forEach((obj) => {
        if (list.find((i) => i.itmPdCd === obj.itmPdCd)) {
          return true;
        }
        target.push(obj);
        return false;
      });
      viewCurrentLength = view.getJsonRows().length;
      view.getDataSource().addRows(target.map((v) => getRowData(v)));
      view.checkAll(false);
      view.resetCurrent();
      if (!isEmpty(target)) {
        await fetchPitmStoc(target, 'A'); // 시점재고 조회
      }
    } else if (type === 'U') {
      const rowData = payload?.[0] || {};
      view.setValues(row, getRowData(rowData), true);
      await fetchPitmStoc([rowData], 'A');
    }
    setTotalCount();
  }
}

// 품목 추가 버튼 클릭
async function onClickAddItems() {
  await openItemBasePopup('C');
}

// 그리드 "사유" 드롭다운 데이터 셋팅
function setReasonCellStyle() {
  const ostrRsonCd = grdMainRef.value.getView().columnByField('ostrRsonCd');

  ostrRsonCd.editable = true;
  ostrRsonCd.editor = { type: 'list' };
  ostrRsonCd.labels = ostrRsonCds.value.map((v) => v.codeName);
  ostrRsonCd.values = ostrRsonCds.value.map((v) => v.codeId);
}

// 입고창고 셋팅
function setStrWareNo() {
  const { codeIdUp, codeNameUp, wareDvCdUp } = warehouses.value.find((v) => v.codeId === searchParams.value.ostrWareNo);
  searchParams.value.strWareNo = codeIdUp;
  searchParams.value.strWareNm = codeNameUp;
  searchParams.value.strWareDvCd = wareDvCdUp;
}

// 출고창고 변경 시 입고 창고 셋팅
async function onChangeOstrWareNo() {
  const view = grdMainRef.value.getView();
  const list = gridUtil.getAllRowValues(view, false);

  // 출고창고 변경시 시점재고 재조회
  if (list.length > 0) {
    await fetchPitmStoc(list, 'A'); // 시점재고 조회
  }

  if (searchParams.value.ostrTpCd === RETURN_INSIDE) {
    setStrWareNo();
  }
}

// 출고유형 변경 시 사유 데이터 변경
function onChangeOstrTp() {
  const { ostrTpCd } = searchParams.value;

  if (ostrTpCd === DISUSE) {
    ostrRsonCds.value = codes.DSU_RSON_CD;
    searchParams.value.strWareNm = '';
  } else if (ostrTpCd === RETURN_INSIDE) {
    ostrRsonCds.value = codes.RTNGD_RSON_CD;
    setStrWareNo();
  } else if (ostrTpCd === RETURN_OUTSIDE) {
    searchParams.value.strWareNm = '';
  }

  setReasonCellStyle();
}

// 파라미터로 받은 값을 조회조건에 셋팅
function setSearchParams() {
  const { ostrTpCd, ostrWareNo, ostrDt, strWareNo, itmOstrNo } = props;
  searchParams.value.ostrTpCd = ostrTpCd;
  searchParams.value.ostrWareNo = ostrWareNo;
  searchParams.value.ostrDt = ostrDt;
  searchParams.value.strWareNo = strWareNo;
  searchParams.value.itmOstrNo = itmOstrNo;
}

const itemOutOfStorage = ref();
// 조회
async function fetchData() {
  const res = await dataService.get('/sms/wells/service/returning-goods-out-of-storages', { params: searchParams.value });
  const { itemOutOfStorage: itemOstr, returningGoods } = res.data;

  itemOutOfStorage.value = itemOstr;

  const view = grdMainRef.value.getView();
  view.getDataSource().setRows(returningGoods);
  setTotalCount();
}

// 기본정보 조회
async function fetchDefaultData() {
  const res = await dataService.get('/sms/wells/service/returning-goods-out-of-storages/warehouses', { params: { userId: employeeIDNumber, apyYm: dayjs().format('YYYYMM') } });
  warehouses.value = res.data;
  if (!res.data[0]) return;

  const { codeId } = res.data[0];
  searchParams.value.ostrWareNo = codeId;
}

// 대상 Object의 빈값 여부 체크
function isNotEmpty(obj) {
  return (obj !== undefined && obj !== null && obj !== '');
}

// 파라미터 체크
function hasProps() {
  return isNotEmpty(props.ostrTpCd) && isNotEmpty(props.ostrWareNo) && isNotEmpty(props.ostrDt);
}

// 출고창고마감 여부 체크
async function isWarehouseClosed() {
  if (!await getWarehouseCloseCheck(searchParams.value.ostrDt, searchParams.value.ostrWareNo)) {
    notify(t('MSG_ALT_DATE_EDIT_OUT_PUT'));
    return true;
  }
  return false;
}

// 삭제
async function onClickDelete() {
  if (await isWarehouseClosed()) return;

  const view = grdMainRef.value.getView();
  const checkedRows = gridUtil.getCheckedRowValues(view);

  if (checkedRows.length === 0) {
    notify(t('MSG_ALT_NO_APPY_OBJ_DT'));
    return;
  }

  // 반품출고 여부 체크
  const returnedGoods = checkedRows.filter((v) => (v.strConfDt !== '' && v.strConfDt !== null && v.strConfDt !== undefined));
  if (returnedGoods.length > 0) {
    notify(t('MSG_ALT_RTNGD_OSTR_FINISH_DEL_IMPSB'));
    return;
  }

  const deletedRows = await gridUtil.confirmDeleteCheckedRows(view);

  setTotalCount();

  if (deletedRows.length > 0) {
    await dataService.delete('/sms/wells/service/returning-goods-out-of-storages', { data: deletedRows.map((v) => ({ ...searchParams.value, ...v })) });
  }
}

// 입고마감 체크
async function validateClosed(itmOstrNo) {
  const { data: isClosed } = await dataService.get('/sms/wells/service/returning-goods-out-of-storages/deadline-check', { params: { itmOstrNo } });
  if (isClosed) {
    notify(t('MSG_ALT_ALREADY_CLOSED_MOD_NOT_POSSIBLE'));
    return false;
  }
  return true;
}

// 저장
async function onClickSave() {
  const view = grdMainRef.value.getView();

  if (gridUtil.getCheckedRowValues(view).length === 0) {
    notify(t('MSG_ALT_NO_APPY_OBJ_DT'));
    return;
  }
  if (!(await gridUtil.validate(view, { isCheckedOnly: true }))) { return; }

  const selectedDay = searchParams.value.ostrDt;

  if (selectedDay > dayjs().format('YYYYMMDD')) {
    // {출고일자}는 오늘이거나 이전 일자만 선택이 가능합니다.
    notify(t('MSG_ALT_TOD_BF_DT_CHO_PSB', [t('MSG_TXT_OSTR_DT')]));
    return;
  }

  const rowCount = view.getItemCount();

  for (let dataRow = 0; dataRow < rowCount; dataRow += 1) {
    const ostrQty = gridUtil.getCellValue(view, dataRow, 'ostrQty');
    if (!validateOstrQty(dataRow, ostrQty)) return;
  }

  // 파주물류센터일 경우 운송코드 필수체크 추가
  if (searchParams.value.strWareNo === '100002' && searchParams.value.trnspnCd === '') {
    notify(t('MSG_ALT_TRNSPN_CD_ATC_VAL_OMSSN_CONF_NCST'));
    return;
  }

  // searchParams 값 체크
  if (searchParams.value.ostrTpCd === '' || searchParams.value.ostrWareNo === '' || searchParams.value.ostrDt === ''
    || ((searchParams.value.ostrTpCd === RETURN_INSIDE || searchParams.value.ostrTpCd === RETURN_OUTSIDE) && searchParams.value.strWareNo === '')) {
    notify(t('MSG_ALT_MISSING_VALUE_PLEASE_CHECK'));
    return;
  }

  if (await isWarehouseClosed()) return;

  const checkedRows = gridUtil.getCheckedRowValues(view);
  const itmOstrNo = checkedRows.map((v) => v.itmOstrNo)[0];

  // 신규 등록이 아닌 수정 건인 경우 입고마감 여부 체크
  if (hasProps() && !await validateClosed(itmOstrNo)) return;

  let params = searchParams.value;
  // 수정 건의 경우 (창고구분코드 = '1' 물류센터)
  if (hasProps() && props.strWareDvCd === '1') {
    params = itemOutOfStorage.value;
  }

  await dataService.post('/sms/wells/service/returning-goods-out-of-storages', checkedRows.map((v) => ({ ...v, ...params })));

  notify(t('MSG_ALT_SAVE_DATA'));

  view.getDataSource().clearRows();
  view.setAllCheck(false);
}

// 마운트 처리
onMounted(async () => {
  await fetchDefaultData();
  onChangeOstrTp();
  if (hasProps()) {
    setSearchParams();
    await fetchData();
  }
});

// 수정 가능 여부 판별
function canEdit() {
  return hasProps() && props.strWareDvCd !== '1';
}

// 수정 불가 셀 셋팅
function setCellEditableFalse() {
  if (canEdit()) {
    return { editable: false };
  }
}

// -------------------------------------------------------------------------------------------------
// Initialize Grid
// -------------------------------------------------------------------------------------------------
const initGrdMain = defineGrid((data, view) => {
  const fields = [
    { fieldName: 'sapMatCd' }, // SAP코드
    { fieldName: 'itmPdCd' }, // 상품코드
    { fieldName: 'itmPdNm' }, // 상품명
    { fieldName: 'itmGdCd' }, // 등급코드
    { fieldName: 'onQty', dataType: 'number' }, // 재고수량
    { fieldName: 'mngtUnitCd' }, // 관리단위
    { fieldName: 'ostrRsonCd' }, // 출고사유코드
    { fieldName: 'ostrQty', dataType: 'number' }, // 출고수량
    { fieldName: 'rmkCn' }, // 비고
    { fieldName: 'strConfDt' }, // 입고확인일자
    { fieldName: 'itmOstrNo' }, // 품목춟고번호
    { fieldName: 'ostrSn' }, // 출고일련번호
    { fieldName: 'itmStrNo' }, // 품목입고번호
    { fieldName: 'strSn' }, // 입고일련번호
    { fieldName: 'itmKndCd' }, // 품목종류코드
    { fieldName: 'acbDt' }, // 회계일자
    { fieldName: 'evidDvCd' }, // 증빙구분코드
    { fieldName: 'strTpCd' }, // 입고유형코드
  ];

  const columns = [
    { fieldName: 'sapMatCd', header: t('MSG_TXT_SAP_CD'), width: '170', styleName: 'text-center' },
    { fieldName: 'itmPdCd', header: t('MSG_TXT_ITM_CD'), width: '140', styleName: 'text-center' },
    { fieldName: 'itmPdNm',
      header: t('MSG_TXT_ITM_NM'),
      width: '200',
      button: 'action',
      styleName: 'rg-button-icon--search',
      styleCallback: () => {
        if (canEdit()) {
          return { styleName: 'rg-button-hide' };
        }
      },
    },
    { fieldName: 'itmGdCd',
      header: t('MSG_TXT_GD'),
      width: '100',
      styleName: 'text-center',
      editable: true,
      editor: { type: 'list' },
      options: pdGdCds,
      rules: 'required',
      styleCallback: setCellEditableFalse,
    },
    { fieldName: 'onQty', header: t('MSG_TXT_STOC_QTY'), width: '100', styleName: 'text-right' },
    { fieldName: 'mngtUnitCd',
      header: t('MSG_TXT_MNGT_UNIT'),
      width: '100',
      styleName: 'text-center',
      options: codes.MNGT_UNIT_CD,
    },
    { fieldName: 'ostrRsonCd',
      header: t('MSG_TXT_RSN'),
      width: '150',
      styleName: 'text-center',
      editable: true,
      editor: {
        type: 'list',
      },
      options: ostrRsonCds.value,
      rules: `required|one_of:${ostrRsonCds.value.map((v) => v.codeId)}`,
      styleCallback: setCellEditableFalse,
    },
    { fieldName: 'ostrQty',
      header: t('MSG_TXT_OSTR_QTY'),
      width: '100',
      styleName: 'text-right',
      editable: true,
      rules: 'required|min_value:1',
      numberFormat: '###,###,###,##0',
      editor: {
        type: 'number',
      },
      styleCallback: setCellEditableFalse,
    },
    { fieldName: 'rmkCn',
      header: t('MSG_TXT_NOTE'),
      width: '397',
      editable: true,
      styleCallback: setCellEditableFalse,
    },
    { fieldName: 'strConfDt' },
    { fieldName: 'itmOstrNo' },
    { fieldName: 'ostrSn' },
    { fieldName: 'itmStrNo' },
    { fieldName: 'strSn' },
    { fieldName: 'itmKndCd' },
    { fieldName: 'acbDt' },
    { fieldName: 'evidDvCd' },
    { fieldName: 'strTpCd' },
  ];

  const columnLayout = [
    'sapMatCd',
    'itmPdCd',
    'itmPdNm',
    'itmGdCd',
    'onQty',
    'mngtUnitCd',
    'ostrRsonCd',
    'ostrQty',
    'rmkCn',
  ];

  data.setFields(fields);
  view.setColumns(columns);
  view.setColumnLayout(columnLayout);

  view.checkBar.visible = true;
  view.rowIndicator.visible = true;
  view.editOptions.columnEditableFirst = true;

  view.onCellButtonClicked = async (grid, { column, itemIndex }) => {
    if (canEdit()) return;
    if (column === 'itmPdNm') {
      await openItemBasePopup('U', itemIndex);
    }
  };

  view.onGetEditValue = async (grid, index, editResult) => {
    grid.checkItem(index.itemIndex, true);

    if (index.fieldName === 'ostrQty') {
      validateOstrQty(index.dataRow, editResult.value);
    }
  };

  view.onCellEdited = async (grid, itemIndex, row, field) => {
    const { itmGdCd } = grid.getValues(itemIndex);
    const dataRow = [grid.getValues(itemIndex)];

    const changedFieldName = grid.getDataSource().getOrgFieldName(field);

    if (changedFieldName === 'itmGdCd') {
      await fetchPitmStoc(dataRow, itmGdCd, itemIndex);
    }
  };
});
</script>
<style>
.kw-search-style .kw-search__action {
  display: none;
}

.rg-button-hide .rg-button-action {
  display: none !important;
}
</style>
